---
title: ETS
output: html_notebook
---

_Copyright (c) Microsoft Corporation._<br/>
_Licensed under the MIT License._

```{r, echo=FALSE, results="hide", message=FALSE}
library(tidyr)
library(dplyr)
library(tsibble)
library(feasts)
library(fable)
```

This notebook fits a simple exponential smoothing state-space model to the orange juice data, using the `ETS` modelling function. Unlike the other modelling functions in the fable package, `ETS` does not currently support time series containing missing values. Therefore we use a previously trained model (ARIMA) to impute missing values first, via the `interpolate` function.

```{r}
srcdir <- here::here("R_utils")
for(src in dir(srcdir, full.names=TRUE)) source(src)

load_objects("oj_retail", "data.Rdata")
load_objects("oj_retail", "model_basic.Rdata")

cl <- make_cluster(libs=c("tidyr", "dplyr", "fable", "tsibble", "feasts"))

oj_modelset_ets <- parallel::clusterMap(cl, function(df, basicmod)
{
    df %>%
        interpolate(object=select(basicmod, -c(mean, naive, drift))) %>%
        model(
            ets=ETS(logmove ~ error("A") + trend("A") + season("N")),
            .safely=FALSE
        )
}, oj_train, oj_modelset_basic)

oj_fcast_ets <- parallel::clusterMap(cl, get_forecasts, oj_modelset_ets, oj_test)

destroy_cluster(cl)

save_objects(oj_modelset_ets, oj_fcast_ets,
             example="oj_retail", file="model_ets.Rdata")

do.call(rbind, oj_fcast_ets) %>%
    mutate_at(-(1:3), exp) %>%
    eval_forecasts()
```

The ETS model does _worse_ than the ARIMA model. We conclude that any simple univariate approach is unlikely to do well in forecasting this data.
